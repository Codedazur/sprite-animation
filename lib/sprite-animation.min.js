(function(m,r){"function"===typeof define&&define.amd?define(["jquery"],function(s){return m.amdWebGlobal=r(s)}):m.amdWebGlobal=r(m.b)})(this,function(m){var r=function(){if(r._instance)return r._instance;var s=m("<div></div>"),y=!1,t,u,q=[],h,v,l=[],w,B,z,a,k,n,x,A;w=function(){0<t.length?(u=t.pop(),y=!0,n(u)||"loading"===n(u)?w():(k(u,"loading"),m.ajax({dataType:"json",url:u,success:B}))):x()};B=function(c,e,p){v=c.meta.image;k(u,c);n(v)?w():a(u.substr(0,u.lastIndexOf("/"))+"/"+v)};a=function(c){h=
new Image;m(h).on("load",function(){z()});h.src=c};z=function(c){k(v,h);w()};k=function(c,a){a instanceof Image?l[c]=a:q[c]=a};n=function(c){return q[c]?q[c]:l[c]?l[c]:null};x=function(){y=!1;A("sprite-cache:loaded")};A=function(c){s.trigger(c)};r._instance={load:function(c,a,p){"string"===typeof c&&(c=[c]);"string"===typeof a&&(a=[a]);c=p&&a?a:c;t=t?t.concat(c):c;y||w()},add:function(a,e){k(a,e)},get:function(a){return n[a]?n[a]:null},atlases:function(){return q},images:function(){return l},flush:function(a){"string"===
typeof a&&(a=[a]);if(void 0===a)q=[],l=[];else{var e,p;for(p in a)e=a[p],void 0!==q[e]&&(void 0!==l[q[e].meta.image]&&(l[q[e].meta.image]=void 0),q[e]=void 0)}},on:function(a,e,p){s.on(a,e,p)},one:function(a,e,p){s.one(a,e,p)},off:function(a,e,p){s.off(a,e,p)}};return r._instance};r.getInstance=function(){return r._instance||new r};return function(s,y){var t=m("<div></div>"),u=void 0!==y?y:!0,q=!1,h,v,l=!0,w=!1,B=!1,z=!1,a=[],k,n,x,A,c,e,p=r.getInstance(),G,N,O,P,Q,R,H,S,I,J,T,K,C,D,L,E,M,F;N=function(){for(var b in a)a[b].setup||
G(b,a[b].frameName,a[b].delimiter,a[b].startIndex,a[b].fps);Q()};G=function(b,f,d,g,c){var e={frameName:f,delimiter:d,setup:!1,startIndex:g,fps:c};a[b]&&(a[b].shouldPlay&&(e.shouldPlay=!0),a[b].loop&&(e.loop=a[b].loop));if(w){for(var m=[],h,l,k,n=p.atlases();(l=O(f,d,g),h=P(l))&&-1!==h&&1E5>g;)k=n[h].frames[l],k.name=l,k.image=n[h].meta.image,k.scale=n[h].meta.scale,m.push(k),g+=1;e.fps=c;e.from=0;e.to=m.length-1;e.frames=m;void 0===e.loop&&(e.loop=!1);a[b]=e}else a[b]=e,M()};P=function(b){var a=
-1,d;for(d in p.atlases())if(p.atlases()[d].frames[b]){a=d;break}return a};O=function(b,a,d){var g=b.split(a).length-1;for(d=d.toString();d.length<g;)d="0"+d;return b.substr(0,b.indexOf(a))+d+b.substr(b.lastIndexOf(a)+1,b.length)};L=function(b,f){var d,g;d=0;for(g=a[b].frames.length;d<g;d+=1)if(a[b].frames[d].name===f)return d;return-1};T=function(){var b={w:0,h:0},f,d,g;for(f in a)for(d in a[f].frames)g=a[f].frames[d],g.sourceSize.w>b.w&&g.sourceSize.h>b.h&&(b.w=g.sourceSize.w/g.scale,b.h=g.sourceSize.h/
g.scale);return b};Q=function(){var b;B=!0;R();D("sprite-animation:ready");for(b in a)if(a[b].shouldPlay){K(b,a[b]);break}};R=function(){var b=T();h=m('<canvas width="'+b.w+'" height="'+b.h+'"></canvas>')[0];F()&&m(h).css({"-moz-transform":"scale(0.5, 0.5)","-ms-transform":"scale(0.5, 0.5)","-webkit-transform":"scale(0.5, 0.5)",transform:"scale(0.5, 0.5)","-moz-transform-origin":"0% 0%","-ms-transform-origin":"0% 0%","-webkit-transform-origin":"0% 0%","transform-origin":"0% 0%"});s&&u&&H();v=h.getContext("2d")};
H=function(){q=!0;m(s).empty();m(s).append(h);x&&I()};S=function(){q&&(m(h).remove(),v=h=null)};I=function(){m(h).css({position:"relative",top:x.y+"px",left:x.x+"px"})};J=function(){return void 0===document.createElement("canvas").getContext||navigator.userAgent.match(/(Android (1.0|1.1|1.5|1.6|2.0|2.1))|(GT-P5110)|(Windows Phone (OS 7))|(XBLWP)|(ZuneWP)|(w(eb)?OSBrowser)|(webOS)|(Kindle\/(1.0|2.0|2.5|3.0))/)?!1:!0};K=function(b,f){f=f?f:{};a[b]&&(B?(q||H(),a[b].from=void 0!==f.from?f.from:0,a[b].to=
void 0!==f.to?f.to:a[b].frames.length-1,a[b].loop=f.loop?f.loop:!1,n=a[b].from,k=b,A=!0,c=!1,e=1E3/a[b].fps,C()):(a[b].shouldPlay=!0,a[b].from=void 0!==f.from?f.from:void 0,a[b].to=void 0!==f.to?f.to:void 0,a[b].loop=void 0!==f.loop?f.loop:void 0))};C=function(){if(!c)if(n<a[k].frames.length&&n<=a[k].to){var b=a[k].frames[n],f=b.frame,d=p.images()[b.image],g=b.scale;E();try{v.drawImage(d,f.x,f.y,f.w,f.h,b.spriteSourceSize.x/g,b.spriteSourceSize.y/g,f.w/g,f.h/g),A&&window.setTimeout(function(){n+=
1;C()},e)}catch(h){throw Error("Error drawing to context",h);}}else a[k].loop?(D("sprite-animation:animation-loop",k),n=a[k].from,C()):(A=!1,D("sprite-animation:animation-done",k))};E=function(){v&&v.clearRect(0,0,h.width,h.height)};D=function(b,a){t.trigger(b,a)};M=function(){z||(z=!0,p.one("sprite-cache:loaded",function(){z=!1;w=!0;N()}))};F=function(){return navigator.userAgent.match(/(Windows Phone)/)?void 0===window.devicePixelRatio&&1<Math.round(window.screen.availWidth/document.documentElement.clientWidth):
void 0!==window.devicePixelRatio&&1<window.devicePixelRatio};return{load:function(b,a){J()?(w=!1,M(),this.cache().load(b,a,F())):(l=!1,m(s).addClass("no-canvas"))},addAnimation:function(b,a,d,g,c){l&&G(b,a,d,g,c)},play:function(b,a,d,c,e){l&&(e=void 0!==e?e:{},"string"===typeof d&&(d=L(b,d),-1===d&&(d=void 0)),"string"===typeof c&&(c=L(b,c),-1===c&&(c=void 0)),e.loop=a,e.from=d,e.to=c,K(b,e))},setOffset:function(b,a){l&&(x={x:b,y:a},h&&q&&I())},stop:function(a){l&&(c=!0,a&&E())},dispose:function(){c||
this.stop();E();S()},setAnimation:function(a){l&&(k=a)},frame:function(a){if(l){if(isNaN(a))return 0;n=Math.round(a);C()}},on:function(a,c,d){t.on(a,c,d)},one:function(a,c,d){t.one(a,c,d)},off:function(a,c,d){t.off(a,c,d)},cache:function(){return r.getInstance()},canvasSupported:function(){return J()},isRetina:function(){return F()}}}});
