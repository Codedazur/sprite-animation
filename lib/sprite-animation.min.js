(function(d,p){"function"===typeof define&&define.amd?define(["jquery"],function(q){return d.amdWebGlobal=p(q)}):d.amdWebGlobal=p(d.b)})(this,function(d){var p=function(){if(p._instance)return p._instance;var q=d("<div></div>"),w=!1,s,t,l=[],u,f,m=[],n,x,z,y,a,h,r,v;n=function(){0<s.length?(t=s.pop(),w=!0,h(t)||"loading"===h(t)?n():(a(t,"loading"),d.ajax({dataType:"json",url:t,success:x}))):r()};x=function(k,b,d){f=k.meta.image;a(t,k);h(f)?n():y(t.substr(0,t.lastIndexOf("/"))+"/"+f)};y=function(k){u=
new Image;d(u).on("load",function(){z()});u.src=k};z=function(k){a(f,u);n()};a=function(k,a){a instanceof Image?m[k]=a:l[k]=a};h=function(a){return l[a]?l[a]:m[a]?m[a]:null};r=function(){w=!1;v("sprite-cache:loaded")};v=function(a){q.trigger(a)};p._instance={load:function(a,b,d){"string"===typeof a&&(a=[a]);"string"===typeof b&&(b=[b]);a=d&&b?b:a;s=s?s.concat(a):a;w||n()},add:function(k,b){a(k,b)},get:function(a){return h[a]?h[a]:null},atlases:function(){return l},images:function(){return m},flush:function(a){"string"===
typeof a&&(a=[a]);if(void 0===a)l=[],m=[];else{var b,d;for(d in a)b=a[d],void 0!==l[b]&&(void 0!==m[l[b].meta.image]&&(m[l[b].meta.image]=void 0),l[b]=void 0)}},on:function(a,b,d){q.on(a,b,d)},one:function(a,b,d){q.one(a,b,d)},off:function(a,d,h){q.off(a,d,h)}};return p._instance};p.getInstance=function(){return p._instance||new p};return function(q,w){var s=d("<div></div>"),t=void 0!==w?w:!0,l=!1,u=void 0!==window.devicePixelRatio?1<window.devicePixelRatio:!1,f,m,n=!0,x=!1,z=!1,y=!1,a=[],h,r,v,k,
b,M,A=p.getInstance(),F,N,O,P,Q,R,G,S,H,I,T,J,B,D,K,E,L;N=function(){for(var c in a)a[c].setup||F(c,a[c].frameName,a[c].delimiter,a[c].startIndex,a[c].fps);Q()};F=function(c,g,e,C,d){var b={frameName:g,delimiter:e,setup:!1,startIndex:C,fps:d};a[c]&&(a[c].shouldPlay&&(b.shouldPlay=!0),a[c].loop&&(b.loop=a[c].loop));if(x){for(var h=[],f,l,k,m=A.atlases();(l=O(g,e,C),f=P(l))&&-1!==f&&1E5>C;)k=m[f].frames[l],k.name=l,k.image=m[f].meta.image,k.scale=m[f].meta.scale,h.push(k),C+=1;b.fps=d;b.from=0;b.to=
h.length-1;b.frames=h;void 0===b.loop&&(b.loop=!1);a[c]=b}else a[c]=b,L()};P=function(c){var a=-1,e;for(e in A.atlases())if(A.atlases()[e].frames[c]){a=e;break}return a};O=function(c,a,e){var b=c.split(a).length-1;for(e=e.toString();e.length<b;)e="0"+e;return c.substr(0,c.indexOf(a))+e+c.substr(c.lastIndexOf(a)+1,c.length)};K=function(c,g){var e,b;e=0;for(b=a[c].frames.length;e<b;e+=1)if(a[c].frames[e].name===g)return e;return-1};T=function(){var c={w:0,h:0},g,e,b;for(g in a)for(e in a[g].frames)b=
a[g].frames[e],b.sourceSize.w>c.w&&b.sourceSize.h>c.h&&(c.w=b.sourceSize.w/b.scale,c.h=b.sourceSize.h/b.scale);return c};Q=function(){var c;z=!0;R();D("sprite-animation:ready");for(c in a)if(a[c].shouldPlay){J(c,a[c]);break}};R=function(){var a=T();f=d('<canvas width="'+a.w+'" height="'+a.h+'"></canvas>')[0];u&&d(f).css({"-moz-transform":"scale(0.5, 0.5)","-ms-transform":"scale(0.5, 0.5)","-webkit-transform":"scale(0.5, 0.5)",transform:"scale(0.5, 0.5)","-moz-transform-origin":"0% 0%","-ms-transform-origin":"0% 0%",
"-webkit-transform-origin":"0% 0%","transform-origin":"0% 0%"});q&&t&&G();m=f.getContext("2d")};G=function(){l=!0;d(q).empty();d(q).append(f);v&&H()};S=function(){l&&(d(f).remove(),m=f=null)};H=function(){d(f).css({position:"relative",top:v.y+"px",left:v.x+"px"})};I=function(){return void 0===document.createElement("canvas").getContext||navigator.userAgent.match(/(Android (1.0|1.1|1.5|1.6|2.0|2.1))|(GT-P5110)|(Windows Phone (OS 7|8.0))|(XBLWP)|(ZuneWP)|(w(eb)?OSBrowser)|(webOS)|(Kindle\/(1.0|2.0|2.5|3.0))/)?
!1:!0};J=function(c,g){g=g?g:{};a[c]&&(z?(l||G(),a[c].from=void 0!==g.from?g.from:0,a[c].to=void 0!==g.to?g.to:a[c].frames.length-1,a[c].loop=g.loop?g.loop:!1,r=a[c].from,h=c,k=!0,b=!1,M=1E3/a[c].fps,B()):(a[c].shouldPlay=!0,a[c].from=void 0!==g.from?g.from:void 0,a[c].to=void 0!==g.to?g.to:void 0,a[c].loop=void 0!==g.loop?g.loop:void 0))};B=function(){if(!b)if(r<a[h].frames.length&&r<=a[h].to){var c=a[h].frames[r],g=c.frame,e=A.images()[c.image],d=c.scale;E();try{m.drawImage(e,g.x,g.y,g.w,g.h,c.spriteSourceSize.x/
d,c.spriteSourceSize.y/d,g.w/d,g.h/d),k&&window.setTimeout(function(){r+=1;B()},M)}catch(f){log("Error drawing to context",f)}}else a[h].loop?(D("sprite-animation:animation-loop",h),r=a[h].from,B()):(k=!1,D("sprite-animation:animation-done",h))};E=function(){m&&m.clearRect(0,0,f.width,f.height)};D=function(a,b){s.trigger(a,b)};L=function(){y||(y=!0,A.one("sprite-cache:loaded",function(){y=!1;x=!0;N()}))};return{load:function(a,b){I()?(x=!1,L(),this.cache().load(a,b,u)):(n=!1,d(q).addClass("no-canvas"))},
addAnimation:function(a,b,e,d,f){n&&F(a,b,e,d,f)},play:function(a,b,e,d,f){n&&(f=void 0!==f?f:{},"string"===typeof e&&(e=K(a,e),-1===e&&(e=void 0)),"string"===typeof d&&(d=K(a,d),-1===d&&(d=void 0)),f.loop=b,f.from=e,f.to=d,J(a,f))},setOffset:function(a,b){n&&(v={x:a,y:b},f&&l&&H())},stop:function(a){n&&(b=!0,a&&E())},dispose:function(){b||this.stop();E();S()},setAnimation:function(a){n&&(h=a)},frame:function(a){if(n){if(isNaN(a))return 0;r=Math.round(a);B()}},on:function(a,b,d){s.on(a,b,d)},one:function(a,
b,d){s.one(a,b,d)},off:function(a,b,d){s.off(a,b,d)},cache:function(){return p.getInstance()},canvasSupported:function(){return I()},isRetina:function(){return u}}}});
