define(["jquery"],function(n){var s=function(){if(s._instance)return s._instance;var t=n("<div></div>"),w=!1,q,r,f=[],u,h,k=[],m,x,z,y,a,e,p,v;m=function(){0<q.length?(r=q.pop(),w=!0,e(r)||"loading"===e(r)?m():(a(r,"loading"),n.ajax({dataType:"json",url:r,success:x}))):p()};x=function(l,b,f){h=l.meta.image;a(r,l);e(h)?m():y(r.substr(0,r.lastIndexOf("/"))+"/"+h)};y=function(l){u=new Image;n(u).on("load",function(){z()});u.src=l};z=function(l){a(h,u);m()};a=function(l,a){a instanceof Image?k[l]=a:f[l]=
a};e=function(a){return f[a]?f[a]:k[a]?k[a]:null};p=function(){w=!1;v("sprite-cache:loaded")};v=function(a){t.trigger(a)};s._instance={load:function(a,b,e){"string"===typeof a&&(a=[a]);"string"===typeof b&&(b=[b]);a=e&&b?b:a;q=q?q.concat(a):a;w||m()},add:function(l,b){a(l,b)},get:function(a){return e[a]?e[a]:null},atlases:function(){return f},images:function(){return k},flush:function(a){"string"===typeof a&&(a=[a]);if(void 0===a)f=[],k=[];else{var b,e;for(e in a)b=a[e],void 0!==f[b]&&(void 0!==k[f[b].meta.image]&&
(k[f[b].meta.image]=void 0),f[b]=void 0)}},on:function(a,b,e){t.on(a,b,e)},one:function(a,b,e){t.one(a,b,e)},off:function(a,e,f){t.off(a,e,f)}};return s._instance};s.getInstance=function(){return s._instance||new s};return function(t,w){var q=n("<div></div>"),r=void 0!==w?w:!0,f=!1,u=void 0!==window.devicePixelRatio?1<window.devicePixelRatio:!1,h,k,m=!0,x=!1,z=!1,y=!1,a=[],e,p,v,l,b,M,A=s.getInstance(),F,N,O,P,Q,R,G,S,H,I,T,J,B,D,K,E,L;N=function(){for(var c in a)a[c].setup||F(c,a[c].frameName,a[c].delimiter,
a[c].startIndex,a[c].fps);Q()};F=function(c,g,d,C,e){var b={frameName:g,delimiter:d,setup:!1,startIndex:C,fps:e};a[c]&&(a[c].shouldPlay&&(b.shouldPlay=!0),a[c].loop&&(b.loop=a[c].loop));if(x){for(var f=[],h,l,k,m=A.atlases();(l=O(g,d,C),h=P(l))&&-1!==h&&1E5>C;)k=m[h].frames[l],k.name=l,k.image=m[h].meta.image,k.scale=m[h].meta.scale,f.push(k),C+=1;b.fps=e;b.from=0;b.to=f.length-1;b.frames=f;void 0===b.loop&&(b.loop=!1);a[c]=b}else a[c]=b,L()};P=function(c){var a=-1,d;for(d in A.atlases())if(A.atlases()[d].frames[c]){a=
d;break}return a};O=function(c,a,d){var b=c.split(a).length-1;for(d=d.toString();d.length<b;)d="0"+d;return c.substr(0,c.indexOf(a))+d+c.substr(c.lastIndexOf(a)+1,c.length)};K=function(c,g){var d,b;d=0;for(b=a[c].frames.length;d<b;d+=1)if(a[c].frames[d].name===g)return d;return-1};T=function(){var c={w:0,h:0},g,d,b;for(g in a)for(d in a[g].frames)b=a[g].frames[d],b.sourceSize.w>c.w&&b.sourceSize.h>c.h&&(c.w=b.sourceSize.w/b.scale,c.h=b.sourceSize.h/b.scale);return c};Q=function(){var c;z=!0;R();D("sprite-animation:ready");
for(c in a)if(a[c].shouldPlay){J(c,a[c]);break}};R=function(){var a=T();h=n('<canvas width="'+a.w+'" height="'+a.h+'"></canvas>')[0];u&&n(h).css({"-moz-transform":"scale(0.5, 0.5)","-ms-transform":"scale(0.5, 0.5)","-webkit-transform":"scale(0.5, 0.5)",transform:"scale(0.5, 0.5)","-moz-transform-origin":"0% 0%","-ms-transform-origin":"0% 0%","-webkit-transform-origin":"0% 0%","transform-origin":"0% 0%"});t&&r&&G();k=h.getContext("2d")};G=function(){f=!0;n(t).empty();n(t).append(h);v&&H()};S=function(){f&&
(n(h).remove(),k=h=null)};H=function(){n(h).css({position:"relative",top:v.y+"px",left:v.x+"px"})};I=function(){return void 0===document.createElement("canvas").getContext||navigator.userAgent.match(/(Android (1.0|1.1|1.5|1.6|2.0|2.1))|(GT-P5110)|(Windows Phone (OS 7|8.0))|(XBLWP)|(ZuneWP)|(w(eb)?OSBrowser)|(webOS)|(Kindle\/(1.0|2.0|2.5|3.0))/)?!1:!0};J=function(c,g){g=g?g:{};a[c]&&(z?(f||G(),a[c].from=void 0!==g.from?g.from:0,a[c].to=void 0!==g.to?g.to:a[c].frames.length-1,a[c].loop=g.loop?g.loop:
!1,p=a[c].from,e=c,l=!0,b=!1,M=1E3/a[c].fps,B()):(a[c].shouldPlay=!0,a[c].from=void 0!==g.from?g.from:void 0,a[c].to=void 0!==g.to?g.to:void 0,a[c].loop=void 0!==g.loop?g.loop:void 0))};B=function(){if(!b)if(p<a[e].frames.length&&p<=a[e].to){var c=a[e].frames[p],g=c.frame,d=A.images()[c.image],f=c.scale;E();try{k.drawImage(d,g.x,g.y,g.w,g.h,c.spriteSourceSize.x/f,c.spriteSourceSize.y/f,g.w/f,g.h/f),l&&window.setTimeout(function(){p+=1;B()},M)}catch(h){log("Error drawing to context",h)}}else a[e].loop?
(D("sprite-animation:animation-loop",e),p=a[e].from,B()):(l=!1,D("sprite-animation:animation-done",e))};E=function(){k&&k.clearRect(0,0,h.width,h.height)};D=function(a,b){q.trigger(a,b)};L=function(){y||(y=!0,A.one("sprite-cache:loaded",function(){y=!1;x=!0;N()}))};return{load:function(a,b){I()?(x=!1,L(),this.cache().load(a,b,u)):(m=!1,n(t).addClass("no-canvas"))},addAnimation:function(a,b,d,e,f){m&&F(a,b,d,e,f)},play:function(a,b,d,e,f){m&&(f=void 0!==f?f:{},"string"===typeof d&&(d=K(a,d),-1===d&&
(d=void 0)),"string"===typeof e&&(e=K(a,e),-1===e&&(e=void 0)),f.loop=b,f.from=d,f.to=e,J(a,f))},setOffset:function(a,b){m&&(v={x:a,y:b},h&&f&&H())},stop:function(a){m&&(b=!0,a&&E())},dispose:function(){b||this.stop();E();S()},setAnimation:function(a){m&&(e=a)},frame:function(a){if(m){if(isNaN(a))return 0;p=Math.round(a);B()}},on:function(a,b,d){q.on(a,b,d)},one:function(a,b,d){q.one(a,b,d)},off:function(a,b,d){q.off(a,b,d)},cache:function(){return s.getInstance()},canvasSupported:function(){return I()},
isRetina:function(){return u}}}});
