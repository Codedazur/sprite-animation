(function(f,l){"function"===typeof define&&define.amd?define(["jquery"],function(m){return f.amdWebGlobal=l(m)}):f.amdWebGlobal=l(f.b)})(this,function(f){var l=function(){if(l._instance)return l._instance;var m=f("<div></div>"),w=!1,t,g,h=[],v,x,c=[],p,q,y,B,u,a,k,r;p=function(){0<t.length?(g=t.pop(),w=!0,a(g)||"loading"===a(g)?p():(u(g,"loading"),f.ajax({dataType:"json",url:g,success:q}))):k()};q=function(s,b,c){x=s.meta.image;u(g,s);a(x)?p():B(g.substr(0,g.lastIndexOf("/"))+"/"+x)};B=function(a){v=
new Image;f(v).on("load",function(){y()});v.src=a};y=function(a){u(x,v);p()};u=function(a,b){b instanceof Image?c[a]=b:h[a]=b};a=function(a){return h[a]?h[a]:c[a]?c[a]:null};k=function(){w=!1;r("sprite-cache:loaded")};r=function(a){m.trigger(a)};l._instance={load:function(a,b,c){"string"===typeof a&&(a=[a]);"string"===typeof b&&(b=[b]);a=c&&b?b:a;t=t?t.concat(a):a;w||p()},add:function(a,b){u(a,b)},get:function(s){return a[s]?a[s]:null},atlases:function(){return h},images:function(){return c},flush:function(a){"string"===
typeof a&&(a=[a]);if(void 0===a)h=[],c=[];else{var b,f;for(f in a)b=a[f],void 0!==h[b]&&void 0!==h[b].meta&&(void 0!==c[h[b].meta.image]&&delete c[h[b].meta.image],delete h[b])}},on:function(a,b,c){m.on(a,b,c)},one:function(a,b,c){m.one(a,b,c)},off:function(a,b,c){m.off(a,b,c)}};return l._instance};l.getInstance=function(){return l._instance||new l};return function(m,w,t){var g=f("<div></div>"),h=void 0!==w&&null!==w?w:!0,v=!1,x=void 0!==t&&null!==t?t:!0,c,p,q=!0,y=!1,B=!1,u=!1,a=[],k,r,s,b,z,M,C=
l.getInstance(),G,N,O,P,Q,R,S,T,H,I,U,J,A,D,K,E,L,F,V;N=function(){for(var d in a)a[d].setup||G(d,a[d].frameName,a[d].delimiter,a[d].startIndex,a[d].fps);Q()};G=function(d,e,n,b,c){var f={frameName:e,delimiter:n,setup:!1,startIndex:b,fps:c};a[d]&&(a[d].shouldPlay&&(f.shouldPlay=!0),a[d].loop&&(f.loop=a[d].loop));if(y){for(var k=[],g,l,h,m=C.atlases();(l=O(e,n,b),g=P(l))&&-1!==g&&1E5>b;)h=m[g].frames[l],h.name=l,h.image=m[g].meta.image,h.scale=m[g].meta.scale,k.push(h),b+=1;f.fps=c;f.from=0;f.to=k.length-
1;f.frames=k;void 0===f.loop&&(f.loop=!1);a[d]=f}else a[d]=f,L()};P=function(d){var a=-1,n;for(n in C.atlases())if(C.atlases()[n].frames[d]){a=n;break}return a};O=function(a,e,n){var b=a.split(e).length-1;for(n=n.toString();n.length<b;)n="0"+n;return a.substr(0,a.indexOf(e))+n+a.substr(a.lastIndexOf(e)+1,a.length)};K=function(d,e){var b,c;b=0;for(c=a[d].frames.length;b<c;b+=1)if(a[d].frames[b].name===e)return b;return-1};U=function(){var d={w:0,h:0},e,b,c,f;for(e in a)for(b in a[e].frames)c=a[e].frames[b],
c.sourceSize.w>d.w&&c.sourceSize.h>d.h&&(f=x?1:c.scale,d.w=c.sourceSize.w/f,d.h=c.sourceSize.h/f);return d};Q=function(){var d;B=!0;D("sprite-animation:ready");for(d in a)if(a[d].shouldPlay){J(d,a[d]);break}};R=function(){var a=U();c=f('<canvas width="'+a.w+'" height="'+a.h+'"></canvas>')[0];F()&&f(c).css({"-moz-transform":"scale(0.5, 0.5)","-ms-transform":"scale(0.5, 0.5)","-webkit-transform":"scale(0.5, 0.5)",transform:"scale(0.5, 0.5)","-moz-transform-origin":"0% 0%","-ms-transform-origin":"0% 0%",
"-webkit-transform-origin":"0% 0%","transform-origin":"0% 0%"});m&&h&&S();p=c.getContext("2d")};S=function(){v=!0;f(m).empty();f(m).append(c);s&&H()};T=function(){v&&(f(c).remove(),p=c=null)};H=function(){f(c).css({position:"relative",top:s.y+"px",left:s.x+"px"})};I=function(){return void 0===document.createElement("canvas").getContext||navigator.userAgent.match(/(Android (1.0|1.1|1.5|1.6|2.0|2.1))|(GT-P5110)|(Windows Phone (OS 7))|(XBLWP)|(ZuneWP)|(w(eb)?OSBrowser)|(webOS)|(Kindle\/(1.0|2.0|2.5|3.0))/)?
!1:!0};J=function(d,e){e=e?e:{};a[d]&&(B?(a[d].from=void 0!==e.from?e.from:0,a[d].to=void 0!==e.to?e.to:a[d].frames.length-1,a[d].loop=e.loop?e.loop:!1,r=a[d].from,k=d,b=!0,z=!1,M=1E3/a[d].fps,A()):(a[d].shouldPlay=!0,a[d].from=void 0!==e.from?e.from:void 0,a[d].to=void 0!==e.to?e.to:void 0,a[d].loop=void 0!==e.loop?e.loop:void 0))};A=function(){if(!z)if(r<a[k].frames.length&&r<=a[k].to){var d=a[k].frames[r],e=d.frame,f=C.images()[d.image],g=x?1:d.scale;c||R();E();try{p.drawImage(f,e.x,e.y,e.w,e.h,
d.spriteSourceSize.x/g,d.spriteSourceSize.y/g,e.w/g,e.h/g),b&&window.setTimeout(function(){r+=1;A()},M)}catch(h){throw Error("Error drawing to context",h);}}else a[k].loop?(D("sprite-animation:animation-loop",k),r=a[k].from,A()):(b=!1,D("sprite-animation:animation-done",k))};E=function(){p&&p.clearRect(0,0,c.width,c.height)};V=function(d){var e;z=!0;b=!1;d&&E();for(e in a)a[e].shouldPlay=!1};D=function(a,e){g.trigger(a,e)};L=function(){u||(u=!0,C.one("sprite-cache:loaded",function(){u=!1;y=!0;N()}))};
F=function(){return navigator.userAgent.match(/(Windows Phone)/)?void 0===window.devicePixelRatio&&1<Math.round(window.screen.availWidth/document.documentElement.clientWidth):void 0!==window.devicePixelRatio&&1<window.devicePixelRatio};return{load:function(a,e){I()?(y=!1,L(),this.cache().load(a,e,F())):(q=!1,f(m).addClass("no-canvas"))},addAnimation:function(a,e,b,c,f){q&&G(a,e,b,c,f)},play:function(a,e,b,c,f){q&&(f=void 0!==f?f:{},"string"===typeof b&&(b=K(a,b),-1===b&&(b=void 0)),"string"===typeof c&&
(c=K(a,c),-1===c&&(c=void 0)),f.loop=e,f.from=b,f.to=c,J(a,f))},resume:function(){q&&k&&a[k]&&(z=!1,b=!0,A())},setOffset:function(a,b){q&&(s={x:a,y:b},c&&v&&H())},stop:function(a){q&&V()},dispose:function(){z||this.stop();E();T()},setAnimation:function(a){q&&(k=a)},frame:function(a){if(q){if(isNaN(a))return 0;r=Math.round(a);A()}},on:function(a,b,c){g.on(a,b,c)},one:function(a,b,c){g.one(a,b,c)},off:function(a,b,c){g.off(a,b,c)},cache:function(){return l.getInstance()},canvasSupported:function(){return I()},
isRetina:function(){return F()},stopped:function(){return z},playing:b}}});
