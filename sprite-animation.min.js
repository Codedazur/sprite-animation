(function(m,r){"function"===typeof define&&define.amd?define(["jquery"],function(s){return m.amdWebGlobal=r(s)}):m.amdWebGlobal=r(m.b)})(this,function(m){var r=function(){if(r._instance)return r._instance;var s=m("<div></div>"),y=!1,t,u,h=[],l,v,k=[],w,B,z,a,n,q,x,A;w=function(){0<t.length?(u=t.pop(),y=!0,q(u)||"loading"===q(u)?w():(n(u,"loading"),m.ajax({dataType:"json",url:u,success:B}))):x()};B=function(c,f,p){v=c.meta.image;n(u,c);q(v)?w():a(u.substr(0,u.lastIndexOf("/"))+"/"+v)};a=function(c){l=
new Image;m(l).on("load",function(){z()});l.src=c};z=function(c){n(v,l);w()};n=function(c,a){a instanceof Image?k[c]=a:h[c]=a};q=function(c){return h[c]?h[c]:k[c]?k[c]:null};x=function(){y=!1;A("sprite-cache:loaded")};A=function(c){s.trigger(c)};r._instance={load:function(c,a,p){"string"===typeof c&&(c=[c]);"string"===typeof a&&(a=[a]);c=p&&a?a:c;t=t?t.concat(c):c;y||w()},add:function(a,f){n(a,f)},get:function(a){return q[a]?q[a]:null},atlases:function(){return h},images:function(){return k},flush:function(a){"string"===
typeof a&&(a=[a]);if(void 0===a)h=[],k=[];else{var f,p;for(p in a)f=a[p],void 0!==h[f]&&void 0!==h[f].meta&&(void 0!==k[h[f].meta.image]&&(k[h[f].meta.image]=void 0),h[f]=void 0)}},on:function(a,f,p){s.on(a,f,p)},one:function(a,f,p){s.one(a,f,p)},off:function(a,f,p){s.off(a,f,p)}};return r._instance};r.getInstance=function(){return r._instance||new r};return function(s,y){var t=m("<div></div>"),u=void 0!==y?y:!0,h=!1,l,v,k=!0,w=!1,B=!1,z=!1,a=[],n,q,x,A,c,f,p=r.getInstance(),G,N,O,P,Q,R,H,S,I,J,T,
K,C,D,L,E,M,F,U;N=function(){for(var b in a)a[b].setup||G(b,a[b].frameName,a[b].delimiter,a[b].startIndex,a[b].fps);Q()};G=function(b,d,e,g,c){var f={frameName:d,delimiter:e,setup:!1,startIndex:g,fps:c};a[b]&&(a[b].shouldPlay&&(f.shouldPlay=!0),a[b].loop&&(f.loop=a[b].loop));if(w){for(var m=[],h,l,k,n=p.atlases();(l=O(d,e,g),h=P(l))&&-1!==h&&1E5>g;)k=n[h].frames[l],k.name=l,k.image=n[h].meta.image,k.scale=n[h].meta.scale,m.push(k),g+=1;f.fps=c;f.from=0;f.to=m.length-1;f.frames=m;void 0===f.loop&&
(f.loop=!1);a[b]=f}else a[b]=f,M()};P=function(b){var a=-1,e;for(e in p.atlases())if(p.atlases()[e].frames[b]){a=e;break}return a};O=function(b,a,e){var g=b.split(a).length-1;for(e=e.toString();e.length<g;)e="0"+e;return b.substr(0,b.indexOf(a))+e+b.substr(b.lastIndexOf(a)+1,b.length)};L=function(b,d){var e,g;e=0;for(g=a[b].frames.length;e<g;e+=1)if(a[b].frames[e].name===d)return e;return-1};T=function(){var b={w:0,h:0},d,e,g;for(d in a)for(e in a[d].frames)g=a[d].frames[e],g.sourceSize.w>b.w&&g.sourceSize.h>
b.h&&(b.w=g.sourceSize.w/g.scale,b.h=g.sourceSize.h/g.scale);return b};Q=function(){var b;B=!0;R();D("sprite-animation:ready");for(b in a)if(a[b].shouldPlay){K(b,a[b]);break}};R=function(){var b=T();l=m('<canvas width="'+b.w+'" height="'+b.h+'"></canvas>')[0];F()&&m(l).css({"-moz-transform":"scale(0.5, 0.5)","-ms-transform":"scale(0.5, 0.5)","-webkit-transform":"scale(0.5, 0.5)",transform:"scale(0.5, 0.5)","-moz-transform-origin":"0% 0%","-ms-transform-origin":"0% 0%","-webkit-transform-origin":"0% 0%",
"transform-origin":"0% 0%"});s&&u&&H();v=l.getContext("2d")};H=function(){h=!0;m(s).empty();m(s).append(l);x&&I()};S=function(){h&&(m(l).remove(),v=l=null)};I=function(){m(l).css({position:"relative",top:x.y+"px",left:x.x+"px"})};J=function(){return void 0===document.createElement("canvas").getContext||navigator.userAgent.match(/(Android (1.0|1.1|1.5|1.6|2.0|2.1))|(GT-P5110)|(Windows Phone (OS 7))|(XBLWP)|(ZuneWP)|(w(eb)?OSBrowser)|(webOS)|(Kindle\/(1.0|2.0|2.5|3.0))/)?!1:!0};K=function(b,d){d=d?
d:{};a[b]&&(B?(h||H(),a[b].from=void 0!==d.from?d.from:0,a[b].to=void 0!==d.to?d.to:a[b].frames.length-1,a[b].loop=d.loop?d.loop:!1,q=a[b].from,n=b,A=!0,c=!1,f=1E3/a[b].fps,C()):(a[b].shouldPlay=!0,a[b].from=void 0!==d.from?d.from:void 0,a[b].to=void 0!==d.to?d.to:void 0,a[b].loop=void 0!==d.loop?d.loop:void 0))};C=function(){if(!c)if(q<a[n].frames.length&&q<=a[n].to){var b=a[n].frames[q],d=b.frame,e=p.images()[b.image],g=b.scale;E();try{v.drawImage(e,d.x,d.y,d.w,d.h,b.spriteSourceSize.x/g,b.spriteSourceSize.y/
g,d.w/g,d.h/g),A&&window.setTimeout(function(){q+=1;C()},f)}catch(h){throw Error("Error drawing to context",h);}}else a[n].loop?(D("sprite-animation:animation-loop",n),q=a[n].from,C()):(A=!1,D("sprite-animation:animation-done",n))};E=function(){v&&v.clearRect(0,0,l.width,l.height)};U=function(b){var d;c=!0;b&&E();for(d in a)a[d].shouldPlay=!1};D=function(b,a){t.trigger(b,a)};M=function(){z||(z=!0,p.one("sprite-cache:loaded",function(){z=!1;w=!0;N()}))};F=function(){return navigator.userAgent.match(/(Windows Phone)/)?
void 0===window.devicePixelRatio&&1<Math.round(window.screen.availWidth/document.documentElement.clientWidth):void 0!==window.devicePixelRatio&&1<window.devicePixelRatio};return{load:function(b,a){J()?(w=!1,M(),this.cache().load(b,a,F())):(k=!1,m(s).addClass("no-canvas"))},addAnimation:function(b,a,e,g,c){k&&G(b,a,e,g,c)},play:function(b,a,e,c,f){k&&(f=void 0!==f?f:{},"string"===typeof e&&(e=L(b,e),-1===e&&(e=void 0)),"string"===typeof c&&(c=L(b,c),-1===c&&(c=void 0)),f.loop=a,f.from=e,f.to=c,K(b,
f))},setOffset:function(a,d){k&&(x={x:a,y:d},l&&h&&I())},stop:function(a){k&&U()},dispose:function(){c||this.stop();E();S()},setAnimation:function(a){k&&(n=a)},frame:function(a){if(k){if(isNaN(a))return 0;q=Math.round(a);C()}},on:function(a,d,c){t.on(a,d,c)},one:function(a,c,e){t.one(a,c,e)},off:function(a,c,e){t.off(a,c,e)},cache:function(){return r.getInstance()},canvasSupported:function(){return J()},isRetina:function(){return F()}}}});
