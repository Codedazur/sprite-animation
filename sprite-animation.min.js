(function(m,r){"function"===typeof define&&define.amd?define(["jquery"],function(s){return m.amdWebGlobal=r(s)}):m.amdWebGlobal=r(m.b)})(this,function(m){var r=function(){if(r._instance)return r._instance;var s=m("<div></div>"),y=!1,t,u,h=[],l,v,k=[],w,B,z,a,n,q,x,A;w=function(){0<t.length?(u=t.pop(),y=!0,q(u)||"loading"===q(u)?w():(n(u,"loading"),m.ajax({dataType:"json",url:u,success:B}))):x()};B=function(e,f,p){v=e.meta.image;n(u,e);q(v)?w():a(u.substr(0,u.lastIndexOf("/"))+"/"+v)};a=function(e){l=
new Image;m(l).on("load",function(){z()});l.src=e};z=function(e){n(v,l);w()};n=function(e,a){a instanceof Image?k[e]=a:h[e]=a};q=function(e){return h[e]?h[e]:k[e]?k[e]:null};x=function(){y=!1;A("sprite-cache:loaded")};A=function(e){s.trigger(e)};r._instance={load:function(e,a,p){"string"===typeof e&&(e=[e]);"string"===typeof a&&(a=[a]);e=p&&a?a:e;t=t?t.concat(e):e;y||w()},add:function(a,f){n(a,f)},get:function(a){return q[a]?q[a]:null},atlases:function(){return h},images:function(){return k},flush:function(a){"string"===
typeof a&&(a=[a]);if(void 0===a)h=[],k=[];else{var f,p;for(p in a)f=a[p],void 0!==h[f]&&void 0!==h[f].meta&&(void 0!==k[h[f].meta.image]&&(k[h[f].meta.image]=void 0),h[f]=void 0)}},on:function(a,f,p){s.on(a,f,p)},one:function(a,f,p){s.one(a,f,p)},off:function(a,f,p){s.off(a,f,p)}};return r._instance};r.getInstance=function(){return r._instance||new r};return function(s,y){var t=m("<div></div>"),u=void 0!==y?y:!0,h=!1,l,v,k=!0,w=!1,B=!1,z=!1,a=[],n,q,x,A,e,f,p=r.getInstance(),G,N,O,P,Q,R,H,S,I,J,T,
K,C,D,L,E,M,F,U;N=function(){for(var b in a)a[b].setup||G(b,a[b].frameName,a[b].delimiter,a[b].startIndex,a[b].fps);Q()};G=function(b,c,d,g,e){var f={frameName:c,delimiter:d,setup:!1,startIndex:g,fps:e};a[b]&&(a[b].shouldPlay&&(f.shouldPlay=!0),a[b].loop&&(f.loop=a[b].loop));if(w){for(var m=[],h,l,k,n=p.atlases();(l=O(c,d,g),h=P(l))&&-1!==h&&1E5>g;)k=n[h].frames[l],k.name=l,k.image=n[h].meta.image,k.scale=n[h].meta.scale,m.push(k),g+=1;f.fps=e;f.from=0;f.to=m.length-1;f.frames=m;void 0===f.loop&&
(f.loop=!1);a[b]=f}else a[b]=f,M()};P=function(b){var a=-1,d;for(d in p.atlases())if(p.atlases()[d].frames[b]){a=d;break}return a};O=function(b,a,d){var g=b.split(a).length-1;for(d=d.toString();d.length<g;)d="0"+d;return b.substr(0,b.indexOf(a))+d+b.substr(b.lastIndexOf(a)+1,b.length)};L=function(b,c){var d,g;d=0;for(g=a[b].frames.length;d<g;d+=1)if(a[b].frames[d].name===c)return d;return-1};T=function(){var b={w:0,h:0},c,d,g;for(c in a)for(d in a[c].frames)g=a[c].frames[d],g.sourceSize.w>b.w&&g.sourceSize.h>
b.h&&(b.w=g.sourceSize.w/g.scale,b.h=g.sourceSize.h/g.scale);return b};Q=function(){var b;B=!0;R();D("sprite-animation:ready");for(b in a)if(a[b].shouldPlay){K(b,a[b]);break}};R=function(){var b=T();l=m('<canvas width="'+b.w+'" height="'+b.h+'"></canvas>')[0];F()&&m(l).css({"-moz-transform":"scale(0.5, 0.5)","-ms-transform":"scale(0.5, 0.5)","-webkit-transform":"scale(0.5, 0.5)",transform:"scale(0.5, 0.5)","-moz-transform-origin":"0% 0%","-ms-transform-origin":"0% 0%","-webkit-transform-origin":"0% 0%",
"transform-origin":"0% 0%"});s&&u&&H();v=l.getContext("2d")};H=function(){h=!0;m(s).empty();m(s).append(l);x&&I()};S=function(){h&&(m(l).remove(),v=l=null)};I=function(){m(l).css({position:"relative",top:x.y+"px",left:x.x+"px"})};J=function(){return void 0===document.createElement("canvas").getContext||navigator.userAgent.match(/(Android (1.0|1.1|1.5|1.6|2.0|2.1))|(GT-P5110)|(Windows Phone (OS 7))|(XBLWP)|(ZuneWP)|(w(eb)?OSBrowser)|(webOS)|(Kindle\/(1.0|2.0|2.5|3.0))/)?!1:!0};K=function(b,c){c=c?
c:{};a[b]&&(B?(h||H(),a[b].from=void 0!==c.from?c.from:0,a[b].to=void 0!==c.to?c.to:a[b].frames.length-1,a[b].loop=c.loop?c.loop:!1,q=a[b].from,n=b,A=!0,e=!1,f=1E3/a[b].fps,C()):(a[b].shouldPlay=!0,a[b].from=void 0!==c.from?c.from:void 0,a[b].to=void 0!==c.to?c.to:void 0,a[b].loop=void 0!==c.loop?c.loop:void 0))};C=function(){if(!e)if(q<a[n].frames.length&&q<=a[n].to){var b=a[n].frames[q],c=b.frame,d=p.images()[b.image],g=b.scale;log(d,p,p.images());E();try{v.drawImage(d,c.x,c.y,c.w,c.h,b.spriteSourceSize.x/
g,b.spriteSourceSize.y/g,c.w/g,c.h/g),A&&window.setTimeout(function(){q+=1;C()},f)}catch(h){log("Error drawing to context",h)}}else a[n].loop?(D("sprite-animation:animation-loop",n),q=a[n].from,C()):(A=!1,D("sprite-animation:animation-done",n))};E=function(){v&&v.clearRect(0,0,l.width,l.height)};U=function(b){var c;e=!0;b&&E();for(c in a)a[c].shouldPlay=!1};D=function(b,a){t.trigger(b,a)};M=function(){z||(z=!0,p.one("sprite-cache:loaded",function(){z=!1;w=!0;N()}))};F=function(){return navigator.userAgent.match(/(Windows Phone)/)?
void 0===window.devicePixelRatio&&1<Math.round(window.screen.availWidth/document.documentElement.clientWidth):void 0!==window.devicePixelRatio&&1<window.devicePixelRatio};return{load:function(b,a){J()?(w=!1,M(),this.cache().load(b,a,F())):(k=!1,m(s).addClass("no-canvas"))},addAnimation:function(b,a,d,g,e){k&&G(b,a,d,g,e)},play:function(b,a,d,e,f){k&&(f=void 0!==f?f:{},"string"===typeof d&&(d=L(b,d),-1===d&&(d=void 0)),"string"===typeof e&&(e=L(b,e),-1===e&&(e=void 0)),f.loop=a,f.from=d,f.to=e,K(b,
f))},setOffset:function(a,c){k&&(x={x:a,y:c},l&&h&&I())},stop:function(a){k&&U()},dispose:function(){e||this.stop();E();S()},setAnimation:function(a){k&&(n=a)},frame:function(a){if(k){if(isNaN(a))return 0;q=Math.round(a);C()}},on:function(a,c,d){t.on(a,c,d)},one:function(a,c,d){t.one(a,c,d)},off:function(a,c,d){t.off(a,c,d)},cache:function(){return r.getInstance()},canvasSupported:function(){return J()},isRetina:function(){return F()}}}});
