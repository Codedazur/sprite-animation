(function(h,r){"function"===typeof define&&define.amd?define(["jquery"],function(s){return h.amdWebGlobal=r(s)}):h.amdWebGlobal=r(h.b)})(this,function(h){var r=function(){if(r._instance)return r._instance;var s=h("<div></div>"),y=!1,t,u,q=[],l,v,m=[],w,B,z,a,k,n,x,A;w=function(){0<t.length?(u=t.pop(),y=!0,n(u)||"loading"===n(u)?w():(k(u,"loading"),h.ajax({dataType:"json",url:u,success:B}))):x()};B=function(c,f,p){v=c.meta.image;k(u,c);n(v)?w():a(u.substr(0,u.lastIndexOf("/"))+"/"+v)};a=function(c){l=
new Image;h(l).on("load",function(){z()});l.src=c};z=function(c){k(v,l);w()};k=function(c,a){a instanceof Image?m[c]=a:q[c]=a};n=function(c){return q[c]?q[c]:m[c]?m[c]:null};x=function(){y=!1;A("sprite-cache:loaded")};A=function(c){s.trigger(c)};r._instance={load:function(c,a,p){"string"===typeof c&&(c=[c]);"string"===typeof a&&(a=[a]);c=p&&a?a:c;t=t?t.concat(c):c;y||w()},add:function(a,f){k(a,f)},get:function(a){return n[a]?n[a]:null},atlases:function(){return q},images:function(){return m},flush:function(a){"string"===
typeof a&&(a=[a]);if(void 0===a)q=[],m=[];else{var f,p;for(p in a)f=a[p],void 0!==q[f]&&void 0!==q[f].meta&&(void 0!==m[q[f].meta.image]&&delete m[q[f].meta.image],delete q[f])}},on:function(a,f,p){s.on(a,f,p)},one:function(a,f,p){s.one(a,f,p)},off:function(a,f,p){s.off(a,f,p)}};return r._instance};r.getInstance=function(){return r._instance||new r};return function(s,y){var t=h("<div></div>"),u=void 0!==y?y:!0,q=!1,l,v,m=!0,w=!1,B=!1,z=!1,a=[],k,n,x,A,c,f,p=r.getInstance(),G,M,N,O,P,Q,R,S,H,I,T,J,
C,D,K,E,L,F,U;M=function(){for(var b in a)a[b].setup||G(b,a[b].frameName,a[b].delimiter,a[b].startIndex,a[b].fps);P()};G=function(b,d,e,g,c){var f={frameName:d,delimiter:e,setup:!1,startIndex:g,fps:c};a[b]&&(a[b].shouldPlay&&(f.shouldPlay=!0),a[b].loop&&(f.loop=a[b].loop));if(w){for(var l=[],h,m,k,n=p.atlases();(m=N(d,e,g),h=O(m))&&-1!==h&&1E5>g;)k=n[h].frames[m],k.name=m,k.image=n[h].meta.image,k.scale=n[h].meta.scale,l.push(k),g+=1;f.fps=c;f.from=0;f.to=l.length-1;f.frames=l;void 0===f.loop&&(f.loop=
!1);a[b]=f}else a[b]=f,L()};O=function(b){var a=-1,e;for(e in p.atlases())if(p.atlases()[e].frames[b]){a=e;break}return a};N=function(b,a,e){var g=b.split(a).length-1;for(e=e.toString();e.length<g;)e="0"+e;return b.substr(0,b.indexOf(a))+e+b.substr(b.lastIndexOf(a)+1,b.length)};K=function(b,d){var e,g;e=0;for(g=a[b].frames.length;e<g;e+=1)if(a[b].frames[e].name===d)return e;return-1};T=function(){var b={w:0,h:0},d,e,g;for(d in a)for(e in a[d].frames)g=a[d].frames[e],g.sourceSize.w>b.w&&g.sourceSize.h>
b.h&&(b.w=g.sourceSize.w/g.scale,b.h=g.sourceSize.h/g.scale);return b};P=function(){var b;B=!0;D("sprite-animation:ready");for(b in a)if(a[b].shouldPlay){J(b,a[b]);break}};Q=function(){var b=T();l=h('<canvas width="'+b.w+'" height="'+b.h+'"></canvas>')[0];F()&&h(l).css({"-moz-transform":"scale(0.5, 0.5)","-ms-transform":"scale(0.5, 0.5)","-webkit-transform":"scale(0.5, 0.5)",transform:"scale(0.5, 0.5)","-moz-transform-origin":"0% 0%","-ms-transform-origin":"0% 0%","-webkit-transform-origin":"0% 0%",
"transform-origin":"0% 0%"});s&&u&&R();v=l.getContext("2d")};R=function(){q=!0;h(s).empty();h(s).append(l);x&&H()};S=function(){q&&(h(l).remove(),v=l=null)};H=function(){h(l).css({position:"relative",top:x.y+"px",left:x.x+"px"})};I=function(){return void 0===document.createElement("canvas").getContext||navigator.userAgent.match(/(Android (1.0|1.1|1.5|1.6|2.0|2.1))|(GT-P5110)|(Windows Phone (OS 7))|(XBLWP)|(ZuneWP)|(w(eb)?OSBrowser)|(webOS)|(Kindle\/(1.0|2.0|2.5|3.0))/)?!1:!0};J=function(b,d){d=d?
d:{};a[b]&&(B?(a[b].from=void 0!==d.from?d.from:0,a[b].to=void 0!==d.to?d.to:a[b].frames.length-1,a[b].loop=d.loop?d.loop:!1,n=a[b].from,k=b,A=!0,c=!1,f=1E3/a[b].fps,C()):(a[b].shouldPlay=!0,a[b].from=void 0!==d.from?d.from:void 0,a[b].to=void 0!==d.to?d.to:void 0,a[b].loop=void 0!==d.loop?d.loop:void 0))};C=function(){if(!c)if(n<a[k].frames.length&&n<=a[k].to){var b=a[k].frames[n],d=b.frame,e=p.images()[b.image],g=b.scale;l||Q();E();try{v.drawImage(e,d.x,d.y,d.w,d.h,b.spriteSourceSize.x/g,b.spriteSourceSize.y/
g,d.w/g,d.h/g),A&&window.setTimeout(function(){n+=1;C()},f)}catch(h){throw Error("Error drawing to context",h);}}else a[k].loop?(D("sprite-animation:animation-loop",k),n=a[k].from,C()):(A=!1,D("sprite-animation:animation-done",k))};E=function(){v&&v.clearRect(0,0,l.width,l.height)};U=function(b){var d;c=!0;b&&E();for(d in a)a[d].shouldPlay=!1};D=function(b,a){t.trigger(b,a)};L=function(){z||(z=!0,p.one("sprite-cache:loaded",function(){z=!1;w=!0;M()}))};F=function(){return navigator.userAgent.match(/(Windows Phone)/)?
void 0===window.devicePixelRatio&&1<Math.round(window.screen.availWidth/document.documentElement.clientWidth):void 0!==window.devicePixelRatio&&1<window.devicePixelRatio};return{load:function(b,a){I()?(w=!1,L(),this.cache().load(b,a,F())):(m=!1,h(s).addClass("no-canvas"))},addAnimation:function(b,a,e,g,c){m&&G(b,a,e,g,c)},play:function(b,a,e,c,f){m&&(f=void 0!==f?f:{},"string"===typeof e&&(e=K(b,e),-1===e&&(e=void 0)),"string"===typeof c&&(c=K(b,c),-1===c&&(c=void 0)),f.loop=a,f.from=e,f.to=c,J(b,
f))},setOffset:function(a,d){m&&(x={x:a,y:d},l&&q&&H())},stop:function(a){m&&U()},dispose:function(){c||this.stop();E();S()},setAnimation:function(a){m&&(k=a)},frame:function(a){if(m){if(isNaN(a))return 0;n=Math.round(a);C()}},on:function(a,d,c){t.on(a,d,c)},one:function(a,c,e){t.one(a,c,e)},off:function(a,c,e){t.off(a,c,e)},cache:function(){return r.getInstance()},canvasSupported:function(){return I()},isRetina:function(){return F()}}}});
