(function(f,k){"function"===typeof define&&define.amd?define(["jquery"],function(p){return f.amdWebGlobal=k(p)}):f.amdWebGlobal=k(f.b)})(this,function(f){var k=function(){if(k._instance)return k._instance;var p=f("<div></div>"),w=!1,t,l,m=[],v,x,d=[],q,s,y,z,u,a,n,r;q=function(){0<t.length?(l=t.pop(),w=!0,a(l)||"loading"===a(l)?q():(u(l,"loading"),f.ajax({dataType:"json",url:l,success:s}))):n()};s=function(h,b,d){x=h.meta.image;u(l,h);a(x)?q():z(l.substr(0,l.lastIndexOf("/"))+"/"+x)};z=function(h){v=
new Image;f(v).on("load",function(){y()});v.src=h};y=function(h){u(x,v);q()};u=function(h,a){a instanceof Image?d[h]=a:m[h]=a};a=function(a){return m[a]?m[a]:d[a]?d[a]:null};n=function(){w=!1;r("sprite-cache:loaded")};r=function(a){p.trigger(a)};k._instance={load:function(a,b,d){"string"===typeof a&&(a=[a]);"string"===typeof b&&(b=[b]);a=d&&b?b:a;t=t?t.concat(a):a;w||q()},add:function(a,b){u(a,b)},get:function(h){return a[h]?a[h]:null},atlases:function(){return m},images:function(){return d},flush:function(a){"string"===
typeof a&&(a=[a]);if(void 0===a)m=[],d=[];else{var b,f;for(f in a)b=a[f],void 0!==m[b]&&void 0!==m[b].meta&&(void 0!==d[m[b].meta.image]&&delete d[m[b].meta.image],delete m[b])}},on:function(a,b,d){p.on(a,b,d)},one:function(a,b,d){p.one(a,b,d)},off:function(a,d,f){p.off(a,d,f)}};return k._instance};k.getInstance=function(){return k._instance||new k};return function(p,w,t){var l=f("<div></div>"),m=void 0!==w&&null!==w?w:!0,v=!1,x=void 0!==t&&null!==t?t:!0,d,q,s=!0,y=!1,z=!1,u=!1,a=[],n,r,h,b,D,N,A=
k.getInstance(),H,O,P,Q,R,S,T,U,I,J,V,K,B,E,L,F,M,G,W;O=function(){for(var c in a)a[c].setup||H(c,a[c].frameName,a[c].delimiter,a[c].startIndex,a[c].fps);R()};H=function(c,e,g,C,d){var b={frameName:e,delimiter:g,setup:!1,startIndex:C,fps:d};a[c]&&(a[c].shouldPlay&&(b.shouldPlay=!0),a[c].loop&&(b.loop=a[c].loop));if(y){for(var f=[],h,l,k,m=A.atlases();(l=P(e,g,C),h=Q(l))&&-1!==h&&1E5>C;)k=m[h].frames[l],k.name=l,k.image=m[h].meta.image,k.scale=m[h].meta.scale,f.push(k),C+=1;b.fps=d;b.from=0;b.to=f.length-
1;b.frames=f;void 0===b.loop&&(b.loop=!1);a[c]=b}else a[c]=b,M()};Q=function(c){var a=-1,g;for(g in A.atlases())if(A.atlases()[g].frames[c]){a=g;break}return a};P=function(c,a,g){var b=c.split(a).length-1;for(g=g.toString();g.length<b;)g="0"+g;return c.substr(0,c.indexOf(a))+g+c.substr(c.lastIndexOf(a)+1,c.length)};L=function(c,e){var g,b;g=0;for(b=a[c].frames.length;g<b;g+=1)if(a[c].frames[g].name===e)return g;return-1};V=function(){var c={w:0,h:0},e,g,b,d;for(e in a)for(g in a[e].frames)b=a[e].frames[g],
b.sourceSize.w>c.w&&b.sourceSize.h>c.h&&(d=x?1:b.scale,c.w=b.sourceSize.w/d,c.h=b.sourceSize.h/d);return c};R=function(){var c;z=!0;E("sprite-animation:ready");for(c in a)if(a[c].shouldPlay){K(c,a[c]);break}};S=function(){var a=V();d=f('<canvas width="'+a.w+'" height="'+a.h+'"></canvas>')[0];G()&&f(d).css({"-moz-transform":"scale(0.5, 0.5)","-ms-transform":"scale(0.5, 0.5)","-webkit-transform":"scale(0.5, 0.5)",transform:"scale(0.5, 0.5)","-moz-transform-origin":"0% 0%","-ms-transform-origin":"0% 0%",
"-webkit-transform-origin":"0% 0%","transform-origin":"0% 0%"});p&&m&&T();q=d.getContext("2d")};T=function(){v=!0;f(p).empty();f(p).append(d);h&&I()};U=function(){v&&(f(d).remove(),q=d=null)};I=function(){f(d).css({position:"relative",top:h.y+"px",left:h.x+"px"})};J=function(){return void 0===document.createElement("canvas").getContext||navigator.userAgent.match(/(Android (1.0|1.1|1.5|1.6|2.0|2.1))|(GT-P5110)|(Windows Phone (OS 7))|(XBLWP)|(ZuneWP)|(w(eb)?OSBrowser)|(webOS)|(Kindle\/(1.0|2.0|2.5|3.0))/)?
!1:!0};K=function(c,e){e=e?e:{};a[c]&&(z?(a[c].from=void 0!==e.from?e.from:0,a[c].to=void 0!==e.to?e.to:a[c].frames.length-1,a[c].loop=e.loop?e.loop:!1,r=a[c].from,n=c,b=!0,D=!1,N=1E3/a[c].fps,B()):(a[c].shouldPlay=!0,a[c].from=void 0!==e.from?e.from:void 0,a[c].to=void 0!==e.to?e.to:void 0,a[c].loop=void 0!==e.loop?e.loop:void 0))};B=function(){if(!D)if(r<a[n].frames.length&&r<=a[n].to){var c=a[n].frames[r],e=c.frame,g=A.images()[c.image],f=x?1:c.scale;d||S();F();try{q.drawImage(g,e.x,e.y,e.w,e.h,
c.spriteSourceSize.x/f,c.spriteSourceSize.y/f,e.w/f,e.h/f),b&&window.setTimeout(function(){r+=1;B()},N)}catch(h){throw Error("Error drawing to context",h);}}else a[n].loop?(E("sprite-animation:animation-loop",n),r=a[n].from,B()):(b=!1,E("sprite-animation:animation-done",n))};F=function(){q&&q.clearRect(0,0,d.width,d.height)};W=function(c){var e;D=!0;c&&F();for(e in a)a[e].shouldPlay=!1};E=function(a,e){l.trigger(a,e)};M=function(){u||(u=!0,A.one("sprite-cache:loaded",function(){u=!1;y=!0;O()}))};
G=function(){return navigator.userAgent.match(/(Windows Phone)/)?void 0===window.devicePixelRatio&&1<Math.round(window.screen.availWidth/document.documentElement.clientWidth):void 0!==window.devicePixelRatio&&1<window.devicePixelRatio};return{load:function(a,e){J()?(y=!1,M(),this.cache().load(a,e,G())):(s=!1,f(p).addClass("no-canvas"))},addAnimation:function(a,e,b,d,f){s&&H(a,e,b,d,f)},play:function(a,e,b,d,f){s&&(f=void 0!==f?f:{},"string"===typeof b&&(b=L(a,b),-1===b&&(b=void 0)),"string"===typeof d&&
(d=L(a,d),-1===d&&(d=void 0)),f.loop=e,f.from=b,f.to=d,K(a,f))},setOffset:function(a,b){s&&(h={x:a,y:b},d&&v&&I())},stop:function(a){s&&W()},dispose:function(){D||this.stop();F();U()},setAnimation:function(a){s&&(n=a)},frame:function(a){if(s){if(isNaN(a))return 0;r=Math.round(a);B()}},on:function(a,b,d){l.on(a,b,d)},one:function(a,b,d){l.one(a,b,d)},off:function(a,b,d){l.off(a,b,d)},cache:function(){return k.getInstance()},canvasSupported:function(){return J()},isRetina:function(){return G()}}}});
